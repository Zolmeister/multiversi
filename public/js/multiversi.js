DEBUG=!0;GAMETYPE="pointcontrol";COLORS=[{name:"red",color:"#caa",activeColor:"#d66",moveColor:"#edd"},{name:"green",color:"#aca",activeColor:"#6d6",moveColor:"#ded"},{name:"blue",color:"#aac",activeColor:"#66d",moveColor:"#dde"}];RENDER={hexShape:{radius:36,apothem:31,smallRadius:36,smallApothem:31},offset:{x:37,y:63}};function distance2(a,c,b,d){return Math.pow(b-a,2)+Math.pow(d-c,2)}function isInt(a){return"number"===typeof a&&parseFloat(a)==parseInt(a,10)&&!isNaN(a)}function getPlayerIndex(a,c){for(var b=0;b<a.length;b++)if(a[b].id===c)return b;return-1};var Connect=function(){var a=this;this.rooms=ko.observableArray([]);this.socket=io.connect();this.socket.on("error",function(a){console.error(a)});this.socket.on("rooms",function(c){a.rooms(c)});this.socket.on("chat",function(a){var b=$("#chat");a=$("<span class='msg'>").text(a.user+": "+a.msg);b.html(b.html()+a.html()+"<br>")});this.join=function(a){console.log("joining: "+a);this.socket.emit("join",{room:a})};this.setName=function(a){localStorage.name=a;this.socket.emit("screenName",a)};this.leaveRoom=
function(){this.socket.emit("leaveRoom")};this.createGame=function(a,b,d){d=d||GAMETYPE;this.socket.emit("createGame",{isPrivate:a||!1,bots:b||!1,gametype:d})};this.sendChat=function(a){a=$(a);var b=a.serializeArray()[0].value;a.find("input").val("");this.socket.emit("chat",b)};this.roomAdmin=function(a,b){this.socket.emit("roomAdmin",{action:a,target:b})};this.move=function(a){this.socket.emit("move",a)}};function RulesSet(a){this.totalMoves=this.movesMade=0;this.game=a}
RulesSet.prototype.newBoard=function(a,c){this.movesMade=0;this.totalMoves=a.width*a.height;for(var b=Array(a.width),d=0;d<a.width;d++){b[d]=Array(a.height);for(var e=0;e<a.height;e++)b[d][e]=-1}for(var f in a.nonrendered)d=a.nonrendered[f],b[d[0]][d[1]]=-2,this.totalMoves--;for(f in a.nonjumpable)d=a.nonjumpable[f],b[d[0]][d[1]]=-3,this.totalMoves--;if("pointcontrol"===a.gametype)for(f in a.controlpoints)d=a.controlpoints[f],b[d[0]][d[1]]=-1;this.setInitialPositions(b,a,c);return b};
RulesSet.prototype.setInitialPositions=function(a,c,b){if(b&&3===b.length)for(var d=0;3>d;d++){var e=b[d].id,f;for(f in c.starting[d]){var g=c.starting[d][f];a[g[0]][g[1]]=e;this.totalMoves--}}};RulesSet.prototype.isControlPoint=function(a,c){if("pointcontrol"===c.gametype)for(var b in c.controlpoints){var d=c.controlpoints[b];if(d[0]===a.i&&d[1]===a.j)return!0}return!1};
RulesSet.prototype.getScoreDiff=function(a,c){var b={},d;for(d in a.gained){var e=a.gained[d],f;for(f in e){var g=e[f];"classic"===c.gametype?b[d]?b[d]++:b[d]=1:"pointcontrol"===c.gametype&&this.isControlPoint(g,c)&&(b[d]?b[d]++:b[d]=1)}}for(d in a.lost)for(f in e=a.lost[d],e)g=e[f],"classic"===c.gametype?b[d]?b[d]--:b[d]=-1:"pointcontrol"===c.gametype&&this.isControlPoint(g,c)&&(b[d]?b[d]--:b[d]=-1);return b};
RulesSet.prototype.getScores=function(a,c,b){var d={};b=b?"classic":c.gametype;for(var e=0;e<c.width;e++)for(var f=0;f<c.height;f++){var g=a[e][f];0>g||(d[g]||(d[g]=0),"classic"===b?d[g]++:"pointcontrol"===b&&this.isControlPoint({i:e,j:f},c)&&d[g]++)}return d};RulesSet.prototype.getPlayerScore=function(a,c,b){a=this.getScores(a,c);return a[b]?a[b]:0};
RulesSet.prototype.gameEnded=function(a,c){if(this.movesMade>=this.totalMoves)return!0;if("pointcontrol"===c.gametype){for(var b in c.controlpoints){var d=c.controlpoints[b];if(this.controlPointCapturable(a,c,{i:d[0],j:d[1]}))return!1}return!0}return!1};
RulesSet.prototype.controlPointCapturable=function(a,c,b){c={};var d={},e={},f=a[b.i][b.j]+"";if(-1===f)return!0;for(var g=0;6>g;g++){c[g]={};d[g]=0;for(var h=b;;){h=this.game.spaceInDirection(h,g);if(void 0===h){e[g]=!1;break}var j=a[h.i][h.j];if(-1===j){e[g]=!0;break}else if(-2===j||-3===j){e[g]=!1;break}void 0===c[g][j]&&(c[g][j]=!0,d[g]++)}}a=!1;for(g=0;6>g;g++)if(b=(g+3)%6,e[g]){e[b]&&(a=!0);for(var k in c[b]){if(void 0===c[g][k]){a=1===d[b]&&k===f?!1:!0;break}if(1===d[b]){a=!1;break}}if(a)break}return a};
"undefined"===typeof module&&(module={});module.exports=RulesSet;var RulesSet=RulesSet||require("./rulesset.js"),directions={upRight:0,up:1,upLeft:2,downLeft:3,down:4,downRight:5};function Game(a,c){this.board=c;this.rules=new RulesSet(this);this.grid=this.rules.newBoard(this.board,a)}Game.prototype.newGame=function(a){this.grid=this.rules.newBoard(this.board,a)};Game.prototype.getScores=function(){return this.rules.getScores(this.grid,this.board)};Game.prototype.getPlayerScore=function(a){return this.rules.getPlayerScore(this.grid,this.board,a)};
Game.prototype.isControlPoint=function(a){return this.rules.isControlPoint(a,this.board)};
Game.prototype.spaceInDirection=function(a,c){var b={i:a.i,j:a.j};if(c===directions.upRight)1===b.i%2&&(b.j-=1),b.i+=1;else if(c===directions.up)b.j-=1;else if(c===directions.upLeft)1===b.i%2&&(b.j-=1),b.i-=1;else if(c===directions.downLeft)0===b.i%2&&(b.j+=1),b.i-=1;else if(c===directions.down)b.j+=1;else if(c===directions.downRight)0===b.i%2&&(b.j+=1),b.i+=1;else return;return 0>b.i||b.i>=this.board.width||0>b.j||b.j>=this.board.height?void 0:b};
Game.prototype.directionFrom=function(a,c){var b=c.i-a.i,d=c.j-a.j;if(0===b){if(a.j<c.j)return directions.down;if(a.j>c.j)return directions.up}else if(0>b)if(0===b%2){if(d===b/2)return directions.upLeft;if(d==b/-2)return directions.downLeft}else if(1===a.i%2){if(d===(b-1)/2)return directions.upLeft;if(d===(b+1)/-2)return directions.downLeft}else{if(d===(b+1)/2)return directions.upLeft;if(d===(b-1)/-2)return directions.downLeft}else if(0===b%2){if(d==b/-2)return directions.upRight;if(d==b/2)return directions.downRight}else if(1===
a.i%2){if(d===(b+1)/-2)return directions.upRight;if(d==(b-1)/2)return directions.downRight}else{if(d===(b-1)/-2)return directions.upRight;if(d==(b+1)/2)return directions.downRight}};
Game.prototype.generateMoveInDirection=function(a,c){if(!(6<=c||0>c)){for(var b={i:a.i,j:a.j},d,e=this.grid[b.i][b.j],f=[],g=this.rules.getScores(this.grid,this.board,!0);;){b=this.spaceInDirection(b,c);if(!b)break;d=this.grid[b.i][b.j];if(d===e||-2===d||-3===d)return;g[d]-=1;if(0===g[d])return 0;f.push(b);if(-1===d)break}return-1!==d||0===f.length?void 0:f}};
Game.prototype.generateMoves=function(a){for(var c={},b=0;6>b;b++){var d=this.generateMoveInDirection(a,b);if(d){var e=d[d.length-1];c[[e.i,e.j]]=d;c[[e.i,e.j]].move={i:e.i,j:e.j}}}return c};Game.prototype.spacesFrom=function(a,c){var b=this.directionFrom(a,c);if(void 0!==b&&(b=this.generateMoveInDirection(a,b))){var d=b[b.length-1];return d.i!==c.i||d.j!==c.j?void 0:b}};
Game.prototype.validateMove=function(a,c,b){if(this.grid[a.i][a.j]!==b||-1!==this.grid[c.i][c.j])return!1;b=this.directionFrom(a,c);if(void 0===b)return!1;if((a=this.generateMoveInDirection(a,b))&&0<a.length)if(a=a[a.length-1],a.i===c.i&&a.j===c.j)return!0;return!1};
Game.prototype.move=function(a,c){var b=this.grid[a.i][a.j],d=this.spacesFrom(a,c),e={gained:{},lost:{}};e.gained[b]=[];if(d){for(var f=0;f<d.length;f++){var g=d[f],h=this.grid[g.i][g.j];h!==b&&-1!==h&&(e.lost[h]||(e.lost[h]=[]),e.lost[h].push(g));e.gained[b].push(g);this.grid[g.i][g.j]=b}this.rules.movesMade++;return e}console.log("Can't genereate spaces between ("+a.i+", "+a.j+") and ("+c.i+", "+c.j+")")};Game.prototype.scoreDiff=function(a){return this.rules.getScoreDiff(a,this.board)};
Game.prototype.gameEnded=function(){return this.rules.gameEnded(this.grid,this.board)};Game.prototype.replacePlayer=function(a,c){for(var b=0;b<this.board.width;b++)for(var d=0;d<this.board.height;d++)this.grid[b][d]===a&&(this.grid[b][d]=c)};Game.prototype.setGrid=function(a){this.grid=a};"undefined"===typeof module&&(module={});module.exports=Game;function Player(a,c,b,d,e,f,g){this.id=a;this.socket=c;this.score=f||0;this.bot=b||!1;this.removed=d||!0;this.isAdmin=e||!1;this.name=g||"Guest"}Player.prototype.clone=function(){return new Player(this.id,{emit:function(){}},this.bot,this.removed,this.isAdmin,this.score,this.name)};function ObservablePlayer(a){this.id=a.id;this.score=ko.observable(a.score);this.bot=ko.observable(a.bot);this.removed=ko.observable(a.removed);this.isAdmin=ko.observable(a.isAdmin);this.name=ko.observable(a.name)}
module=module||{};module.exports=Player;var Render=function(a){this.canvasId=a;this.paper=Raphael($(this.canvasId)[0],0,0);this.lastBoard=void 0;this.spaces={};this.turnOrder=[0,0,0];this.clickedSpace=this.possibleMovesSet=this.controlPointSet=this.playerSpaces=this.spacesSet=this.me=void 0;this.paper.customAttributes.i=function(a){return{i:a}};this.paper.customAttributes.j=function(a){return{j:a}};this.possibleMovesClickHandler=this.playerSpacesClickHandler=void 0};
function hexagonPathString(a){for(var c=Math.PI/3,b,d,e="m"+a+",0",f=1;6>f;f++)b=a*Math.cos(c*f),d=a*Math.sin(c*f),e=e+"L"+b+","+d;return e+"z"}Render.prototype.hexSpaceCenter=function(a,c){var b=a*1.5*RENDER.hexShape.radius,d=c*2*RENDER.hexShape.apothem;1==a%2&&(d-=RENDER.hexShape.apothem);return{x:b+RENDER.offset.x,y:d+RENDER.offset.y}};
Render.prototype.getDimensions=function(a){var c=2*RENDER.hexShape.radius*a.width+2,c=c+0.5*RENDER.hexShape.radius;a=2*RENDER.hexShape.apothem*a.height+2;a+=RENDER.hexShape.apothem;return{width:c,height:a}};
Render.prototype.setBoard=function(a){if(void 0!=this.playerSpaces&&a!=this.lastBoard){this.lastBoard=a;var c=this.getDimensions(a);this.paper.setSize(c.width,c.height);this.spacesSet=this.paper.set();this.controlPointSet=this.paper.set();DEBUG&&(this.debugNumbers=this.paper.set());this.spaces=Array(a.width);c=hexagonPathString(RENDER.hexShape.radius);console.log(c);for(var b=0;b<a.width;b++){this.spaces[b]=Array(a.height);for(var d=0;d<a.height;d++){var e=this.hexSpaceCenter(b,d),f=this.paper.path(c).attr({i:b,
j:d,fill:"#fff"});f.translate(e.x,e.y);this.spacesSet.push(f);this.spaces[b][d]=f;DEBUG&&(e=this.paper.text(e.x,e.y,b+" "+d).attr({i:b,j:d}),this.debugNumbers.push(e))}}for(var g in a.nonrendered)f=a.nonrendered[g],this.spaces[f[0]][f[1]].attr({stroke:"#fff",fill:"",opacity:0});for(g in a.nonjumpable)f=a.nonjumpable[g],this.spaces[f[0]][f[1]].attr({fill:"#444"});for(g in a.controlpoints)f=a.controlpoints[g],e=this.hexSpaceCenter(f[0],f[1]),c=this.paper.circle(e.x,e.y,18).attr({stroke:"",fill:"#FFB00F"}),
this.controlPointSet.push(c);for(b=0;3>b;b++)for(g in a.starting[b])f=a.starting[b][g],this.playerSpaces[this.turnOrder[b]].push(this.spaces[f[0]][f[1]]);DEBUG&&this.debugNumbers.toFront();this.applyAttributes()}};Render.prototype.setPlayers=function(a,c){for(var b in this.playerSpaces)this.playerSpaces[b].clear();this.playerSpaces={};for(b=0;b<a.length;b++){var d=a[b].id;void 0==d&&(d=a[b]().id);this.playerSpaces[d]=this.paper.set();this.turnOrder[b]=d}void 0!==c&&-1!==c&&(this.me=c,this.applyAttributes())};
Render.prototype.replacePlayer=function(a,c){if(this.playerSpaces){a===this.me&&(this.me=c);this.playerSpaces[c]=this.playerSpaces[a];delete this.playerSpaces[a];var b=this.turnOrder.lastIndexOf(a);this.turnOrder[b]=c+""}};
Render.prototype.applyAttributes=function(){if(void 0!==this.playerSpaces){for(var a=0;3>a;a++)this.playerSpaces[this.turnOrder[a]].attr({fill:COLORS[a].color});this.playerSpaces[this.me]&&this.playerSpacesClickHandler&&(this.playerSpaces[this.me].unclick(this.playerSpacesClickHandler),this.playerSpaces[this.me].click(this.playerSpacesClickHandler))}void 0!==this.possibleMovesSet&&(a=this.turnOrder.lastIndexOf(this.me),0<=a&&this.possibleMovesSet.attr({fill:COLORS[a].moveColor}),this.possibleMovesSet&&
this.possibleMovesClickHandler&&(this.possibleMovesSet.unclick(this.possibleMovesClickHandler),this.possibleMovesSet.click(this.possibleMovesClickHandler)))};
Render.prototype.setGrid=function(a,c){if(!(void 0===this.playerSpaces||void 0===this.me)){this.playerSpaces.hasOwnProperty(this.me)&&this.playerSpaces[this.me].unclick(this.playerSpacesClickHandler);for(var b=0;3>b;b++)this.playerSpaces[this.turnOrder[b]].clear();for(b=0;b<c.width;b++)for(var d=0;d<c.height;d++){var e=a[b][d];this.playerSpaces.hasOwnProperty(e)&&this.playerSpaces[e].push(this.spaces[b][d])}this.applyAttributes()}};
Render.prototype.setMove=function(a){if(!(void 0===this.playerSpaces||void 0===this.me)){for(var c in a.lost){var b=a.lost[c],d;for(d in b){var e=b[d];this.playerSpaces[c].exclude(this.spaces[e.i][e.j]);c===this.me&&this.spaces[e.i][e.j].unclick(this.playerSpacesClickHandler)}}for(c in a.gained)for(d in b=a.gained[c],b)e=b[d],this.playerSpaces[c].push(this.spaces[e.i][e.j]);this.applyAttributes()}};
Render.prototype.setPossibleMoves=function(a){this.possibleMovesSet?(this.possibleMovesSet.attr({fill:"#fff"}),this.possibleMovesSet.unclick(this.possibleMovesClickHandler),this.possibleMovesSet.clear()):this.possibleMovesSet=this.paper.set();for(var c in a){var b=a[c][a[c].length-1];this.possibleMovesSet.push(this.spaces[b.i][b.j])}this.applyAttributes()};Render.prototype.setClickedSpace=function(a){this.clickedSpace=this.spaces[a.i][a.j]};var Input=function(a){var c=this;this.room=a;this.clickedSpace={i:-1,j:-1};this.possibleMoves={};this.onClickHandler=this.defaultPlayerOnClick;this.possibleMoveOnClickHandler=this.defaultPossibleMoveOnClick;this.playerOnClick=function(){c.onClickHandler.call(c,{i:this.attr("i"),j:this.attr("j")})};this.possibleMovesOnClick=function(){c.possibleMoveOnClickHandler.call(c,{i:this.attr("i"),j:this.attr("j")})}};
Input.prototype.defaultPlayerOnClick=function(a){this.room.currentPlayerId()!==this.room.me()?console.log("not your turn"):(this.room.game().grid[a.i][a.j]===this.room.me()&&(this.clickedSpace.i===a.i&&this.clickedSpace.j===a.j?(this.clickedSpace.i=-1,this.clickedSpace.j=-1,this.possibleMoves={}):(this.clickedSpace.i=a.i,this.clickedSpace.j=a.j,this.possibleMoves=this.room.game().generateMoves(a))),this.room.renderer.setPossibleMoves(this.possibleMoves))};
Input.prototype.defaultPossibleMoveOnClick=function(a){this.possibleMoves[[a.i,a.j]]&&(this.room.move({start:this.clickedSpace,end:a}),this.room.connect().move({start:this.clickedSpace,end:a}),this.possibleMoves={},this.room.renderer.setPossibleMoves({}),this.clickedSpace={i:-1,j:-1})};Input.prototype.defaultRightclickCallback=function(){};var Room=function(a,c,b,d){var e=this;this.players=ko.observableArray(this.dummyPlayers());this.turn=ko.observable(-1);this.connect=globalConnect;this.socket=this.connect().socket;this.isPublic=ko.observable(!0);this.me=ko.observable(b);this.game=ko.observable(new Game(this.players(),c));d&&this.game().setGrid(d);this.started=ko.observable(!1);this.ended=ko.observable(!1);this.joinRoom=function(a){e.connect().join(a.roomId)};this.iAmAdmin=ko.computed(function(){var a=e.getPlayer(e.me());return a?
a.isAdmin():!1},this);this.kick=function(a){e.connect().roomAdmin("kick",a.id)};this.ban=function(a){e.connect().roomAdmin("ban",a.id)};this.passMove=function(){this.move({start:"pass",end:"pass"});this.connect().move({start:"pass",end:"pass"})};this.currentPlayerId=ko.computed(function(){var a=e.players()[e.turn()];return a?a.id:-1},this)};
Room.prototype.initRenderer=function(){this.input=new Input(this);this.renderer=new Render("#mv-canvas");this.renderer.playerSpacesClickHandler=this.input.playerOnClick;this.renderer.possibleMovesClickHandler=this.input.possibleMovesOnClick;this.renderer.setPlayers(this.players(),this.me());this.renderer.setBoard(this.game().board);this.renderer.setGrid(this.game().grid,this.game().board)};Room.prototype.selfDestruct=function(){this.renderer&&this.renderer.paper.remove()};
Room.prototype.indexToColor=function(a){return COLORS[a]};Room.prototype.dummyPlayers=function(){for(var a=[],c=0;3>c;c++){var b=ko.observable(new ObservablePlayer(new Player(c+1,{emit:function(){}})));a[c]=b}return a};Room.prototype.getPlayer=function(a){for(var c in this.players()){var b=this.players()[c];if(b.id===a)return b}};Room.prototype.getPlayerIndex=function(a){return getPlayerIndex(this.players(),a)};
Room.prototype.move=function(a){"pass"!==a.start&&(a=this.game().move(a.start,a.end),this.mergeScores(this.game().scoreDiff(a)),this.renderer.setMove(a))};Room.prototype.mergeScores=function(a){for(var c in a)this.getPlayer(c)&&this.getPlayer(c).score(this.getPlayer(c).score()+a[c]);this.players.valueHasMutated()};
Room.prototype.update=function(a){for(var c in a){console.log(c+": ");console.log(a[c]);"started"===c&&!0===a[c]&&!this.started()&&(this.started(!0),this.initRenderer());"move"===c&&this.currentPlayerId()!==this.me()&&this.move(a[c]);if("players"===c){for(var b=0;b<a[c].length;b++){var d=new ObservablePlayer(a[c][b]),e=this.players()[b].id;void 0===e&&(e=this.players()[b]().id);console.log("Replace player: "+e+" to "+d.id);e!==d.id&&(this.game().replacePlayer(e,d.id),this.renderer&&this.renderer.replacePlayer(e,
d.id));this.players()[b]=d}this.players.valueHasMutated()}"turn"===c&&this.turn(a[c]);"isPublic"===c&&(this.isPublic(a[c]),console.log("SETTING PUBLIC STATUS:"),console.log(a[c]));"grid"===c&&(console.log("update grid state"),b=a[c],this.game()?(this.game().setGrid(b),this.renderer&&this.renderer.setGrid(b,this.game().board)):console.error("havent recieved board"));"end"===c&&(this.ended(!0),console.log("game ended"))}};function Lobby(){var a=this;this.room=ko.observable(void 0);var c=this.inRoom();this.name=localStorage.name||"Guest";globalConnect().setName(this.name);window.history.replaceState("lobby","lobbly","/");c&&this.joinRoom(c);this.windowEvent=function(b){var c=a.inRoom();"lobby"===b.state&&!c?(console.log("lobby, leaving room"),a.leaveRoom()):"room"===b.state&&a.joinRoom(c)};this.joinRoomClick=function(b){a.joinRoom(b.roomId)};window.addEventListener("popstate",this.windowEvent);ko.applyBindings(this.room,
$("#roomView")[0]);globalConnect().socket.on("gameState",function(b){a.room()?a.room().update(b):b.room&&(b.board&&b.me)&&(a.setRoom(b.room,b.board,b.me,b.grid),a.room().update(b))});globalConnect().socket.on("removed",function(){a.leaveRoom()})}Lobby.prototype.setRoom=function(a,c,b,d){"room"!==window.history.state&&window.history.pushState("room","room","/"+a);this.room(new Room(a,c,b,d))};Lobby.prototype.createRoom=function(a,c,b,d,e){globalConnect().createGame(b,d,e)};
Lobby.prototype.createRoomBots=function(a){a.createRoom(a,null,!0,!0,GAMETYPE)};Lobby.prototype.createRoomPrivate=function(a){a.createRoom(a,null,!0,!1,GAMETYPE)};Lobby.prototype.leaveRoom=function(){this.room()&&(this.room().selfDestruct(),this.room(void 0),globalConnect().leaveRoom(),"room"===window.history.state&&window.history.back())};Lobby.prototype.joinRoom=function(a){globalConnect().join(a)};
Lobby.prototype.inRoom=function(){var a=window.location.href.split("/").pop();return"string"===typeof a&&3<=a.length?a:!1};$(function(){DEBUG&&(localStorage.name="Guest");globalConnect=ko.observable(new Connect);lobby=new Lobby;ko.applyBindings(lobby,$("#homePageView")[0])});function clickJoinRoom(){lobby.joinRoom()}function clickInviteFriends(){lobby.createRoomPrivate(lobby)}function openScreenNameOverlay(){$("#screenNameOverlay").show()}function onScreenNameInputKeyPress(a){a||(a=window.event);"13"==(a.keyCode||a.which)&&applyScreenName()}
function applyScreenName(){globalConnect().setName($("#screenNameInput").val());$("#screenNameOverlay").hide()};
